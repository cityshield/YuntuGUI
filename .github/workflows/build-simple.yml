name: ðŸªŸ Simple Qt Build (Fixed)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘

env:
  QT_VERSION: 6.5.3
  CMAKE_VERSION: 3.21.0
  BUILD_TYPE: Release

jobs:
  build-simple:
    runs-on: windows-2022
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
    
    - name: ðŸ”§ Setup MSVC 2022
      uses: microsoft/setup-msbuild@v1.3
      with:
        vs-version: '17.0'
    
    - name: ðŸ“¦ Install Qt 6.5.3 (Stable)
      uses: jurplel/install-qt-action@v3
      with:
        version: '6.5.3'
        host: windows
        target: desktop
        arch: win64_msvc2019_64
        modules: 'qtbase qttools'
        cache: true
    
    - name: ðŸ”§ Setup CMake
      uses: jwlawson/actions-setup-cmake@v1.14
      with:
        cmake-version: '3.21.0'
    
    - name: ðŸ” Verify Environment
      run: |
        echo "=== Qt ä¿¡æ¯ ==="
        qmake --version
        echo "Qt è·¯å¾„: $env:Qt6_DIR"
        
        echo "=== CMake ä¿¡æ¯ ==="
        cmake --version
        
        echo "=== ç¼–è¯‘å™¨ä¿¡æ¯ ==="
        cl 2>&1 | Select-String "Microsoft"
    
    - name: ðŸ“ Create Build Directory
      run: |
        mkdir build
        cd build
    
    - name: âš™ï¸ Configure CMake (Simplified)
      run: |
        cd build
        
        # ä½¿ç”¨ç®€åŒ–çš„ CMake é…ç½®
        cmake .. -G "Visual Studio 17 2022" -A x64 `
          -DCMAKE_BUILD_TYPE=Release `
          -DCMAKE_PREFIX_PATH="$env:Qt6_DIR" `
          -DQt6_DIR="$env:Qt6_DIR" `
          -DCMAKE_CXX_STANDARD=17
        
        # æ˜¾ç¤ºé…ç½®ç»“æžœ
        echo "=== CMake é…ç½®ç»“æžœ ==="
        cmake --build . --config Release --target help | Select-String "YuntuGUI"
    
    - name: ðŸ”¨ Build Application
      run: |
        cd build
        cmake --build . --config Release --parallel 2
        
        # æ£€æŸ¥æž„å»ºç»“æžœ
        if (Test-Path "Release/YuntuGUI.exe") {
          echo "âœ… æž„å»ºæˆåŠŸï¼"
          $size = (Get-Item "Release/YuntuGUI.exe").Length
          echo "ðŸ“Š æ–‡ä»¶å¤§å°: $([math]::Round($size / 1MB, 2)) MB"
        } else {
          echo "âŒ æ‰¾ä¸åˆ° YuntuGUI.exe"
          echo "=== æž„å»ºç›®å½•å†…å®¹ ==="
          Get-ChildItem -Recurse | Select-Object Name, Length
          exit 1
        }
    
    - name: ðŸ“¦ Deploy Qt Libraries
      run: |
        cd build/Release
        
        # æ£€æŸ¥å¯æ‰§è¡Œæ–‡ä»¶
        if (Test-Path "YuntuGUI.exe") {
          echo "ðŸš€ å¼€å§‹éƒ¨ç½² Qt åº“..."
          
          # ä½¿ç”¨ windeployqt éƒ¨ç½²
          windeployqt YuntuGUI.exe --no-translations --no-system-d3d-compiler --no-opengl-sw
          
          echo "âœ… Qt åº“éƒ¨ç½²å®Œæˆ"
          
          # æ˜¾ç¤ºéƒ¨ç½²åŽçš„æ–‡ä»¶
          echo "=== éƒ¨ç½²åŽçš„æ–‡ä»¶ ==="
          Get-ChildItem | Select-Object Name, Length | Sort-Object Length -Descending
          
        } else {
          echo "âŒ æ‰¾ä¸åˆ° YuntuGUI.exeï¼Œè·³è¿‡éƒ¨ç½²"
          exit 1
        }
    
    - name: ðŸ“¦ Package Release
      run: |
        # åˆ›å»ºå‘å¸ƒåŒ…
        $timestamp = Get-Date -Format "yyyyMMdd-HHmmss"
        $packageName = "YuntuGUI-Windows-Simple-$timestamp"
        
        mkdir $packageName
        Copy-Item -Recurse "build/Release/*" "$packageName/"
        
        # æ·»åŠ è¯´æ˜Žæ–‡ä»¶
        @"
        YuntuGUI - Qt Shadcn/UI è®¤è¯ç•Œé¢
        
        æž„å»ºä¿¡æ¯:
        - Qt ç‰ˆæœ¬: 6.5.3
        - æž„å»ºæ—¶é—´: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
        - æäº¤å“ˆå¸Œ: $env:GITHUB_SHA
        - æž„å»ºç±»åž‹: ç®€åŒ–æž„å»º (ä¿®å¤ç‰ˆ)
        
        è¿è¡Œè¯´æ˜Ž:
        1. åŒå‡» YuntuGUI.exe å¯åŠ¨ç¨‹åº
        2. ç•Œé¢å°ºå¯¸: 900x600 åƒç´ 
        3. æ”¯æŒæ‰‹æœºå·ç™»å½•å’Œå¾®ä¿¡æ‰«ç ç™»å½•
        
        ç³»ç»Ÿè¦æ±‚:
        - Windows 10 æˆ–æ›´é«˜ç‰ˆæœ¬
        - æ”¯æŒçš„åˆ†è¾¨çŽ‡: 1024x768 æˆ–æ›´é«˜
        
        æ•…éšœæŽ’é™¤:
        - å¦‚æžœç¨‹åºæ— æ³•å¯åŠ¨ï¼Œè¯·æ£€æŸ¥æ˜¯å¦å®‰è£…äº† Visual C++ Redistributable
        - å¦‚æžœç•Œé¢æ˜¾ç¤ºå¼‚å¸¸ï¼Œè¯·å°è¯•è°ƒæ•´ç³»ç»Ÿ DPI è®¾ç½®
        "@ > "$packageName/README.txt"
        
        # åˆ›å»ºå¯åŠ¨è„šæœ¬
        @"
        @echo off
        echo ðŸš€ å¯åŠ¨ YuntuGUI - Qt Shadcn/UI è®¤è¯ç•Œé¢
        echo ç‰ˆæœ¬: ç®€åŒ–æž„å»º v1.0.0
        echo æž„å»ºæ—¶é—´: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
        echo.
        YuntuGUI.exe
        pause
        "@ > "$packageName/å¯åŠ¨ç¨‹åº.bat"
        
        # åˆ›å»ºåŽ‹ç¼©åŒ…
        Compress-Archive -Path "$packageName/*" -DestinationPath "$packageName.zip"
        
        echo "PACKAGE_NAME=$packageName" >> $env:GITHUB_ENV
        echo "âœ… å‘å¸ƒåŒ…åˆ›å»ºå®Œæˆ: $packageName.zip"
    
    - name: ðŸ“¤ Upload Build Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: YuntuGUI-Simple-Build
        path: ${{ env.PACKAGE_NAME }}.zip
        retention-days: 7
    
    - name: ðŸ“‹ Build Summary
      if: always()
      run: |
        echo "## ðŸŽ¯ ç®€åŒ–æž„å»ºç»“æžœ" >> $env:GITHUB_STEP_SUMMARY
        echo "" >> $env:GITHUB_STEP_SUMMARY
        
        if (Test-Path "build/Release/YuntuGUI.exe") {
          echo "âœ… **æž„å»ºæˆåŠŸ**" >> $env:GITHUB_STEP_SUMMARY
          echo "" >> $env:GITHUB_STEP_SUMMARY
          
          $size = (Get-Item "build/Release/YuntuGUI.exe").Length
          echo "ðŸ“Š **åº”ç”¨ç¨‹åºå¤§å°**: $([math]::Round($size / 1MB, 2)) MB" >> $env:GITHUB_STEP_SUMMARY
          echo "" >> $env:GITHUB_STEP_SUMMARY
          echo "ðŸŽ‰ **YuntuGUI ç®€åŒ–æž„å»ºå®Œæˆï¼**" >> $env:GITHUB_STEP_SUMMARY
          echo "" >> $env:GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ **ä¸‹è½½**: åœ¨ Artifacts ä¸­ä¸‹è½½ $env:PACKAGE_NAME.zip" >> $env:GITHUB_STEP_SUMMARY
          
        } else {
          echo "âŒ **æž„å»ºå¤±è´¥**" >> $env:GITHUB_STEP_SUMMARY
          echo "" >> $env:GITHUB_STEP_SUMMARY
          echo "è¯·æ£€æŸ¥æž„å»ºæ—¥å¿—èŽ·å–è¯¦ç»†ä¿¡æ¯ã€‚" >> $env:GITHUB_STEP_SUMMARY
        }
        
        echo "" >> $env:GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ æž„å»ºé…ç½®" >> $env:GITHUB_STEP_SUMMARY
        echo "- Qt: 6.5.3 (ç¨³å®šç‰ˆ)" >> $env:GITHUB_STEP_SUMMARY
        echo "- CMake: 3.21.0" >> $env:GITHUB_STEP_SUMMARY
        echo "- ç¼–è¯‘å™¨: MSVC 2019" >> $env:GITHUB_STEP_SUMMARY
        echo "- å¹³å°: Windows x64" >> $env:GITHUB_STEP_SUMMARY
        echo "- æž„å»ºç±»åž‹: ç®€åŒ–ä¿®å¤ç‰ˆ" >> $env:GITHUB_STEP_SUMMARY
