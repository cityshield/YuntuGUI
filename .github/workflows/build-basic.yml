name: ðŸªŸ Basic Qt Build (No Modules)

on:
  workflow_dispatch:  # ä»…æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]

jobs:
  build-basic:
    runs-on: windows-2022
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
    
    - name: ðŸ”§ Setup Visual Studio
      uses: microsoft/setup-msbuild@v1.3
      with:
        vs-version: '17.0'
    
    - name: ðŸ“¦ Install Qt 6.5.3 (Basic)
      uses: jurplel/install-qt-action@v3
      with:
        version: '6.5.3'
        host: windows
        target: desktop
        arch: win64_msvc2019_64
        # ä¸æŒ‡å®š modulesï¼Œä½¿ç”¨é»˜è®¤å®‰è£…
        cache: true
    
    - name: ðŸ”§ Install CMake
      uses: jwlawson/actions-setup-cmake@v1.14
      with:
        cmake-version: '3.21.0'
    
    - name: ðŸ” Simple Environment Check
      run: |
        echo "=== ç®€å•çŽ¯å¢ƒæ£€æŸ¥ ==="
        echo "Qt è·¯å¾„: $env:Qt6_DIR"
        echo "CMake ç‰ˆæœ¬:"
        cmake --version
        echo "qmake ç‰ˆæœ¬:"
        qmake --version
        echo "=== æ£€æŸ¥ Qt å®‰è£… ==="
        if (Test-Path "$env:Qt6_DIR") {
          echo "âœ… Qt ç›®å½•å­˜åœ¨: $env:Qt6_DIR"
          Get-ChildItem "$env:Qt6_DIR" | Select-Object Name
        } else {
          echo "âŒ Qt ç›®å½•ä¸å­˜åœ¨"
        }
        echo "âœ… çŽ¯å¢ƒæ£€æŸ¥å®Œæˆï¼Œè·³è¿‡ç¼–è¯‘å™¨æ£€æŸ¥"
    
    - name: ðŸ“ Create Build Dir
      run: mkdir build
    
    - name: âš™ï¸ Configure with Debug
      run: |
        cd build
        echo "=== å¼€å§‹ CMake é…ç½® ==="
        echo "Qt6_DIR: $env:Qt6_DIR"
        echo "CMAKE_PREFIX_PATH: $env:Qt6_DIR"
        
        cmake .. -G "Visual Studio 17 2022" -A x64 `
          -DCMAKE_BUILD_TYPE=Release `
          -DCMAKE_PREFIX_PATH="$env:Qt6_DIR" `
          -DQt6_DIR="$env:Qt6_DIR"
        
        echo "=== CMake é…ç½®å®Œæˆ ==="
    
    - name: ðŸ”¨ Build with MSBuild
      run: |
        cd build
        echo "=== å¼€å§‹æž„å»º (ä½¿ç”¨ MSBuild) ==="
        # ä½¿ç”¨ MSBuild ç›´æŽ¥æž„å»ºï¼Œé¿å…ç¼–è¯‘å™¨æ£€æŸ¥é—®é¢˜
        msbuild YuntuGUI.sln /p:Configuration=Release /p:Platform=x64 /verbosity:normal
        echo "=== æž„å»ºå®Œæˆ ==="
    
    - name: ðŸ” Check Build Result
      run: |
        echo "=== æ£€æŸ¥æž„å»ºç»“æžœ ==="
        if (Test-Path "build/Release/YuntuGUI.exe") {
          echo "âœ… æ‰¾åˆ° YuntuGUI.exe"
          $size = (Get-Item "build/Release/YuntuGUI.exe").Length
          echo "ðŸ“Š æ–‡ä»¶å¤§å°: $([math]::Round($size / 1MB, 2)) MB"
        } else {
          echo "âŒ æ‰¾ä¸åˆ° YuntuGUI.exe"
          echo "=== æž„å»ºç›®å½•å†…å®¹ ==="
          Get-ChildItem -Recurse build/ | Select-Object Name, Length
          echo "=== Release ç›®å½•å†…å®¹ ==="
          if (Test-Path "build/Release") {
            Get-ChildItem build/Release/ | Select-Object Name, Length
          } else {
            echo "Release ç›®å½•ä¸å­˜åœ¨"
          }
        }
    
    - name: ðŸ“¦ Simple Package
      run: |
        if (Test-Path "build/Release/YuntuGUI.exe") {
          echo "=== åˆ›å»ºç®€å•æ‰“åŒ… ==="
          mkdir package
          Copy-Item "build/Release/YuntuGUI.exe" "package/"
          
          # åˆ›å»ºè¯´æ˜Žæ–‡ä»¶
          @"
          YuntuGUI - åŸºç¡€æž„å»ºç‰ˆæœ¬
          
          æž„å»ºæ—¶é—´: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
          æäº¤: $env:GITHUB_SHA
          
          è¿è¡Œæ–¹æ³•:
          1. åŒå‡» YuntuGUI.exe
          2. å¦‚æžœæç¤ºç¼ºå°‘ DLLï¼Œè¯·å®‰è£… Visual C++ Redistributable
          
          æ³¨æ„: è¿™æ˜¯åŸºç¡€æž„å»ºç‰ˆæœ¬ï¼Œä½¿ç”¨é»˜è®¤ Qt å®‰è£…
          "@ > "package/README.txt"
          
          # æ‰“åŒ…
          Compress-Archive -Path "package/*" -DestinationPath "YuntuGUI-Basic.zip"
          echo "âœ… æ‰“åŒ…å®Œæˆ: YuntuGUI-Basic.zip"
        } else {
          echo "âŒ æž„å»ºå¤±è´¥ï¼Œæ— æ³•æ‰“åŒ…"
          exit 1
        }
    
    - name: ðŸ“¤ Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: YuntuGUI-Basic-Build
        path: YuntuGUI-Basic.zip
        retention-days: 7
    
    - name: ðŸ“‹ Final Report
      if: always()
      run: |
        echo "## ðŸŽ¯ åŸºç¡€æž„å»ºæŠ¥å‘Š" >> $env:GITHUB_STEP_SUMMARY
        echo "" >> $env:GITHUB_STEP_SUMMARY
        
        if (Test-Path "build/Release/YuntuGUI.exe") {
          echo "âœ… **åŸºç¡€æž„å»ºæˆåŠŸ**" >> $env:GITHUB_STEP_SUMMARY
          echo "" >> $env:GITHUB_STEP_SUMMARY
          echo "ðŸŽ‰ **YuntuGUI åŸºç¡€ç‰ˆæœ¬æž„å»ºå®Œæˆï¼**" >> $env:GITHUB_STEP_SUMMARY
          echo "" >> $env:GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ **ä¸‹è½½**: åœ¨ Artifacts ä¸­ä¸‹è½½ YuntuGUI-Basic.zip" >> $env:GITHUB_STEP_SUMMARY
          echo "" >> $env:GITHUB_STEP_SUMMARY
          echo "âš ï¸ **æ³¨æ„**: è¿™æ˜¯åŸºç¡€ç‰ˆæœ¬ï¼Œä½¿ç”¨é»˜è®¤ Qt å®‰è£…" >> $env:GITHUB_STEP_SUMMARY
        } else {
          echo "âŒ **åŸºç¡€æž„å»ºå¤±è´¥**" >> $env:GITHUB_STEP_SUMMARY
          echo "" >> $env:GITHUB_STEP_SUMMARY
          echo "è¯·æ£€æŸ¥æž„å»ºæ—¥å¿—ï¼Œå¯èƒ½éœ€è¦è¿›ä¸€æ­¥è°ƒè¯•ã€‚" >> $env:GITHUB_STEP_SUMMARY
        }
        
        echo "" >> $env:GITHUB_STEP_SUMMARY
        echo "### ðŸ”§ åŸºç¡€æž„å»ºé…ç½®" >> $env:GITHUB_STEP_SUMMARY
        echo "- Qt: 6.5.3 (é»˜è®¤å®‰è£…ï¼Œæ— é¢å¤–æ¨¡å—)" >> $env:GITHUB_STEP_SUMMARY
        echo "- CMake: 3.21.0" >> $env:GITHUB_STEP_SUMMARY
        echo "- ç¼–è¯‘å™¨: MSVC 2019" >> $env:GITHUB_STEP_SUMMARY
        echo "- æž„å»ºç±»åž‹: åŸºç¡€ç‰ˆ (æ— æ¨¡å—ä¾èµ–)" >> $env:GITHUB_STEP_SUMMARY
