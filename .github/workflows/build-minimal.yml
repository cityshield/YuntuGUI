name: ðŸªŸ Minimal Qt Build (Ultra Simple)

on:
  workflow_dispatch:  # ä»…æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]

jobs:
  build-minimal:
    runs-on: windows-2022
    
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
    
    - name: ðŸ”§ Setup Visual Studio
      uses: microsoft/setup-msbuild@v1.3
      with:
        vs-version: '17.0'
    
    - name: ðŸ“¦ Install Qt 6.5.3 (Minimal)
      uses: jurplel/install-qt-action@v3
      with:
        version: '6.5.3'
        host: windows
        target: desktop
        arch: win64_msvc2019_64
        modules: ''
        cache: true
    
    - name: ðŸ”§ Install CMake
      uses: jwlawson/actions-setup-cmake@v1.14
      with:
        cmake-version: '3.21.0'
    
    - name: ðŸ” Debug Environment
      run: |
        echo "=== çŽ¯å¢ƒä¿¡æ¯ ==="
        echo "Qt è·¯å¾„: $env:Qt6_DIR"
        echo "CMake ç‰ˆæœ¬:"
        cmake --version
        echo "ç¼–è¯‘å™¨:"
        if (Get-Command cl -ErrorAction SilentlyContinue) {
          cl 2>&1 | Select-String "Microsoft"
        } else {
          echo "âš ï¸ cl ç¼–è¯‘å™¨æœªåœ¨ PATH ä¸­æ‰¾åˆ°ï¼Œä½†æž„å»ºå¯èƒ½ä»èƒ½ç»§ç»­"
        }
        echo "qmake ç‰ˆæœ¬:"
        qmake --version
    
    - name: ðŸ“ Create Build Dir
      run: mkdir build
    
    - name: âš™ï¸ Configure with Debug
      run: |
        cd build
        echo "=== å¼€å§‹ CMake é…ç½® ==="
        cmake .. -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH="$env:Qt6_DIR" -DQt6_DIR="$env:Qt6_DIR"
        echo "=== CMake é…ç½®å®Œæˆ ==="
    
    - name: ðŸ”¨ Build with Debug
      run: |
        cd build
        echo "=== å¼€å§‹æž„å»º ==="
        cmake --build . --config Release --verbose
        echo "=== æž„å»ºå®Œæˆ ==="
    
    - name: ðŸ” Check Build Result
      run: |
        echo "=== æ£€æŸ¥æž„å»ºç»“æžœ ==="
        if (Test-Path "build/Release/YuntuGUI.exe") {
          echo "âœ… æ‰¾åˆ° YuntuGUI.exe"
          $size = (Get-Item "build/Release/YuntuGUI.exe").Length
          echo "ðŸ“Š æ–‡ä»¶å¤§å°: $([math]::Round($size / 1MB, 2)) MB"
        } else {
          echo "âŒ æ‰¾ä¸åˆ° YuntuGUI.exe"
          echo "=== æž„å»ºç›®å½•å†…å®¹ ==="
          Get-ChildItem -Recurse build/ | Select-Object Name, Length
          echo "=== Release ç›®å½•å†…å®¹ ==="
          if (Test-Path "build/Release") {
            Get-ChildItem build/Release/ | Select-Object Name, Length
          } else {
            echo "Release ç›®å½•ä¸å­˜åœ¨"
          }
        }
    
    - name: ðŸ“¦ Simple Package
      run: |
        if (Test-Path "build/Release/YuntuGUI.exe") {
          echo "=== åˆ›å»ºç®€å•æ‰“åŒ… ==="
          mkdir package
          Copy-Item "build/Release/YuntuGUI.exe" "package/"
          
          # å°è¯•éƒ¨ç½² Qt åº“
          try {
            cd package
            windeployqt YuntuGUI.exe --no-translations
            echo "âœ… Qt åº“éƒ¨ç½²æˆåŠŸ"
          } catch {
            echo "âš ï¸ Qt åº“éƒ¨ç½²å¤±è´¥ï¼Œä½†ç»§ç»­æ‰“åŒ…"
          }
          
          # åˆ›å»ºè¯´æ˜Žæ–‡ä»¶
          @"
          YuntuGUI - æžç®€æž„å»ºç‰ˆæœ¬
          
          æž„å»ºæ—¶é—´: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
          æäº¤: $env:GITHUB_SHA
          
          è¿è¡Œæ–¹æ³•:
          1. åŒå‡» YuntuGUI.exe
          2. å¦‚æžœæç¤ºç¼ºå°‘ DLLï¼Œè¯·å®‰è£… Visual C++ Redistributable
          
          æ³¨æ„: è¿™æ˜¯æžç®€æž„å»ºç‰ˆæœ¬ï¼Œå¯èƒ½ç¼ºå°‘ä¸€äº›ä¾èµ–åº“
          "@ > "package/README.txt"
          
          # æ‰“åŒ…
          Compress-Archive -Path "package/*" -DestinationPath "YuntuGUI-Minimal.zip"
          echo "âœ… æ‰“åŒ…å®Œæˆ: YuntuGUI-Minimal.zip"
        } else {
          echo "âŒ æž„å»ºå¤±è´¥ï¼Œæ— æ³•æ‰“åŒ…"
          exit 1
        }
    
    - name: ðŸ“¤ Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: YuntuGUI-Minimal-Build
        path: YuntuGUI-Minimal.zip
        retention-days: 7
    
    - name: ðŸ“‹ Final Report
      if: always()
      run: |
        echo "## ðŸŽ¯ æžç®€æž„å»ºæŠ¥å‘Š" >> $env:GITHUB_STEP_SUMMARY
        echo "" >> $env:GITHUB_STEP_SUMMARY
        
        if (Test-Path "build/Release/YuntuGUI.exe") {
          echo "âœ… **æžç®€æž„å»ºæˆåŠŸ**" >> $env:GITHUB_STEP_SUMMARY
          echo "" >> $env:GITHUB_STEP_SUMMARY
          echo "ðŸŽ‰ **YuntuGUI æžç®€ç‰ˆæœ¬æž„å»ºå®Œæˆï¼**" >> $env:GITHUB_STEP_SUMMARY
          echo "" >> $env:GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ **ä¸‹è½½**: åœ¨ Artifacts ä¸­ä¸‹è½½ YuntuGUI-Minimal.zip" >> $env:GITHUB_STEP_SUMMARY
          echo "" >> $env:GITHUB_STEP_SUMMARY
          echo "âš ï¸ **æ³¨æ„**: è¿™æ˜¯æžç®€ç‰ˆæœ¬ï¼Œå¯èƒ½éœ€è¦é¢å¤–å®‰è£… Visual C++ Redistributable" >> $env:GITHUB_STEP_SUMMARY
        } else {
          echo "âŒ **æžç®€æž„å»ºå¤±è´¥**" >> $env:GITHUB_STEP_SUMMARY
          echo "" >> $env:GITHUB_STEP_SUMMARY
          echo "è¯·æ£€æŸ¥æž„å»ºæ—¥å¿—ï¼Œå¯èƒ½éœ€è¦è¿›ä¸€æ­¥è°ƒè¯•ã€‚" >> $env:GITHUB_STEP_SUMMARY
        }
        
        echo "" >> $env:GITHUB_STEP_SUMMARY
        echo "### ðŸ”§ æžç®€æž„å»ºé…ç½®" >> $env:GITHUB_STEP_SUMMARY
        echo "- Qt: 6.5.3 (ä»… qtbase æ¨¡å—)" >> $env:GITHUB_STEP_SUMMARY
        echo "- CMake: 3.21.0" >> $env:GITHUB_STEP_SUMMARY
        echo "- ç¼–è¯‘å™¨: MSVC 2019" >> $env:GITHUB_STEP_SUMMARY
        echo "- æž„å»ºç±»åž‹: æžç®€ç‰ˆ (æœ€å°ä¾èµ–)" >> $env:GITHUB_STEP_SUMMARY
