name: ðŸªŸ Build Windows Qt 6.5 (Fallback)

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - '.github/**'
      - '!.github/workflows/**'

env:
  QT_VERSION: 6.5.3
  CMAKE_VERSION: 3.21.0
  BUILD_TYPE: Release

jobs:
  build-qt65:
    runs-on: windows-2022
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: ðŸ”§ è®¾ç½® MSVC çŽ¯å¢ƒ
      uses: microsoft/setup-msbuild@v1.3
    
    - name: ðŸ“¦ å®‰è£… Qt 6.5.3
      uses: jurplel/install-qt-action@v3
      with:
        version: '6.5.3'
        host: windows
        target: desktop
        arch: win64_msvc2019_64
        modules: 'qtbase qttools qt5compat'
        cache: true
    
    - name: ðŸ”§ è®¾ç½® CMake
      uses: jwlawson/actions-setup-cmake@v1.14
      with:
        cmake-version: '3.21.0'
    
    - name: ðŸ” éªŒè¯çŽ¯å¢ƒ
      run: |
        echo "=== Qt ä¿¡æ¯ ==="
        qmake --version
        echo "Qt è·¯å¾„: $env:Qt6_DIR"
        
        echo "=== CMake ä¿¡æ¯ ==="
        cmake --version
        
        echo "=== ç¼–è¯‘å™¨ä¿¡æ¯ ==="
        cl 2>&1 | Select-String "Microsoft"
    
    - name: âš™ï¸ é…ç½®é¡¹ç›®
      run: |
        mkdir build
        cd build
        
        # ä½¿ç”¨å…¼å®¹çš„ CMake é…ç½®
        cmake .. -G "Visual Studio 17 2022" -A x64 `
          -DCMAKE_BUILD_TYPE=Release `
          -DCMAKE_PREFIX_PATH="$env:Qt6_DIR" `
          -DQt6_DIR="$env:Qt6_DIR"
    
    - name: ðŸ”¨ ç¼–è¯‘é¡¹ç›®
      run: |
        cd build
        cmake --build . --config Release --parallel 4
    
    - name: ðŸ“¦ éƒ¨ç½² Qt åº“
      run: |
        cd build/Release
        
        # æ£€æŸ¥å¯æ‰§è¡Œæ–‡ä»¶
        if (Test-Path "MyApp.exe") {
          echo "âœ… æ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶"
          
          # éƒ¨ç½² Qt ä¾èµ–
          windeployqt MyApp.exe --no-translations --no-system-d3d-compiler
          
          # æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨
          echo "=== éƒ¨ç½²åŽçš„æ–‡ä»¶ ==="
          Get-ChildItem -Name
          
        } else {
          echo "âŒ æ‰¾ä¸åˆ° MyApp.exe"
          echo "=== æž„å»ºç›®å½•å†…å®¹ ==="
          Get-ChildItem -Recurse
          exit 1
        }
    
    - name: ðŸŽ¯ æµ‹è¯•åº”ç”¨ç¨‹åº
      run: |
        cd build/Release
        
        # æ£€æŸ¥ DLL ä¾èµ–
        echo "=== æ£€æŸ¥ DLL ä¾èµ– ==="
        dumpbin /dependents MyApp.exe | Select-String "\.dll"
        
        # æ£€æŸ¥æ–‡ä»¶å¤§å°
        $size = (Get-Item "MyApp.exe").Length / 1MB
        echo "ðŸ“Š åº”ç”¨ç¨‹åºå¤§å°: $([math]::Round($size, 2)) MB"
    
    - name: ðŸ“¦ æ‰“åŒ…å‘å¸ƒ
      run: |
        # åˆ›å»ºå‘å¸ƒåŒ…
        $timestamp = Get-Date -Format "yyyyMMdd-HHmmss"
        $packageName = "QtShadcnAuth-Windows-Qt6.5-$timestamp"
        
        mkdir $packageName
        Copy-Item -Recurse "build/Release/*" "$packageName/"
        
        # æ·»åŠ è¯´æ˜Žæ–‡ä»¶
        @"
        Qt Shadcn/UI è®¤è¯ç•Œé¢ - Windows ç‰ˆæœ¬
        
        æž„å»ºä¿¡æ¯:
        - Qt ç‰ˆæœ¬: 6.5.3
        - æž„å»ºæ—¶é—´: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
        - æäº¤å“ˆå¸Œ: $env:GITHUB_SHA
        
        è¿è¡Œè¯´æ˜Ž:
        1. åŒå‡» MyApp.exe å¯åŠ¨ç¨‹åº
        2. ç•Œé¢å°ºå¯¸: 900x600 åƒç´ 
        3. æ”¯æŒæ‰‹æœºå·ç™»å½•å’Œå¾®ä¿¡æ‰«ç ç™»å½•
        
        ç³»ç»Ÿè¦æ±‚:
        - Windows 10 æˆ–æ›´é«˜ç‰ˆæœ¬
        - æ”¯æŒçš„åˆ†è¾¨çŽ‡: 1024x768 æˆ–æ›´é«˜
        "@ > "$packageName/README.txt"
        
        # åˆ›å»ºåŽ‹ç¼©åŒ…
        Compress-Archive -Path "$packageName/*" -DestinationPath "$packageName.zip"
        
        echo "PACKAGE_NAME=$packageName" >> $env:GITHUB_ENV
    
    - name: ðŸ“¤ ä¸Šä¼ æž„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.PACKAGE_NAME }}
        path: ${{ env.PACKAGE_NAME }}.zip
        retention-days: 7
    
    - name: ðŸ“‹ æž„å»ºæŠ¥å‘Š
      if: always()
      run: |
        echo "## ðŸŽ¯ Qt 6.5 æž„å»ºæŠ¥å‘Š" >> $env:GITHUB_STEP_SUMMARY
        echo "" >> $env:GITHUB_STEP_SUMMARY
        
        if (Test-Path "build/Release/MyApp.exe") {
          echo "âœ… **æž„å»ºæˆåŠŸ**" >> $env:GITHUB_STEP_SUMMARY
          echo "" >> $env:GITHUB_STEP_SUMMARY
          
          $size = (Get-Item "build/Release/MyApp.exe").Length
          echo "ðŸ“Š **åº”ç”¨ç¨‹åºå¤§å°**: $([math]::Round($size / 1MB, 2)) MB" >> $env:GITHUB_STEP_SUMMARY
          echo "" >> $env:GITHUB_STEP_SUMMARY
          echo "ðŸŽ‰ **Qt Shadcn/UI è®¤è¯ç•Œé¢ç¼–è¯‘å®Œæˆï¼**" >> $env:GITHUB_STEP_SUMMARY
          echo "" >> $env:GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ **ä¸‹è½½**: åœ¨ Actions é¡µé¢çš„ Artifacts ä¸­ä¸‹è½½ $env:PACKAGE_NAME.zip" >> $env:GITHUB_STEP_SUMMARY
          
        } else {
          echo "âŒ **æž„å»ºå¤±è´¥**" >> $env:GITHUB_STEP_SUMMARY
          echo "" >> $env:GITHUB_STEP_SUMMARY
          echo "è¯·æ£€æŸ¥æž„å»ºæ—¥å¿—èŽ·å–è¯¦ç»†ä¿¡æ¯ã€‚" >> $env:GITHUB_STEP_SUMMARY
        }
        
        echo "" >> $env:GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ æž„å»ºé…ç½®" >> $env:GITHUB_STEP_SUMMARY
        echo "- Qt: 6.5.3" >> $env:GITHUB_STEP_SUMMARY
        echo "- CMake: 3.21.0" >> $env:GITHUB_STEP_SUMMARY
        echo "- ç¼–è¯‘å™¨: MSVC 2022" >> $env:GITHUB_STEP_SUMMARY
        echo "- å¹³å°: Windows x64" >> $env:GITHUB_STEP_SUMMARY
