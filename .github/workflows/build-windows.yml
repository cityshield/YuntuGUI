name: ðŸªŸ Build Windows Qt Application

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]

env:
  QT_VERSION: 6.9.0
  CMAKE_VERSION: 3.27.1
  BUILD_TYPE: Release

jobs:
  build-windows:
    runs-on: windows-2022
    
    strategy:
      matrix:
        arch: [x64]
        qt_version: [6.9.0]
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: ðŸ”§ Setup MSVC
      uses: microsoft/setup-msbuild@v1.3
      with:
        vs-version: '17.0'
    
    - name: ðŸ“¦ Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: ${{ matrix.qt_version }}
        host: windows
        target: desktop
        arch: win64_msvc2022_64
        modules: ''
        cache: true
        cache-key-prefix: 'install-qt-action'
    
    - name: ðŸ” Verify Qt Installation
      run: |
        qmake --version
        where qmake
        echo "Qt installation path: ${{ env.Qt6_DIR }}"
        echo "CMAKE_PREFIX_PATH: $env:CMAKE_PREFIX_PATH"
    
    - name: ðŸ”§ Setup CMake
      uses: jwlawson/actions-setup-cmake@v1.14
      with:
        cmake-version: ${{ env.CMAKE_VERSION }}
    
    - name: ðŸ” Verify Build Environment
      run: |
        cmake --version
        cl
        echo "Build environment ready"
    
    - name: ðŸ“ Create Build Directory
      run: |
        mkdir build
        cd build
    
    - name: âš™ï¸ Configure CMake
      run: |
        cd build
        cmake .. -G "Visual Studio 17 2022" -A x64 `
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} `
          -DCMAKE_PREFIX_PATH="${{ env.Qt6_DIR }}" `
          -DQt6_DIR="${{ env.Qt6_DIR }}"
    
    - name: ðŸ”¨ Build Application
      run: |
        cd build
        cmake --build . --config ${{ env.BUILD_TYPE }} --parallel
    
    - name: ðŸ“¦ Deploy Qt Libraries
      run: |
        cd build/${{ env.BUILD_TYPE }}
        windeployqt MyApp.exe --qmldir ../../ --no-translations --no-system-d3d-compiler --no-opengl-sw
        
        # æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶
        echo "Generated files:"
        ls -la
    
    - name: ðŸ“Š Check Application
      run: |
        cd build/${{ env.BUILD_TYPE }}
        if (Test-Path "MyApp.exe") {
          echo "âœ… Application built successfully"
          $size = (Get-Item "MyApp.exe").Length
          echo "ðŸ“Š File size: $size bytes"
        } else {
          echo "âŒ Application not found"
          exit 1
        }
    
    - name: ðŸ“¦ Package Application
      run: |
        cd build/${{ env.BUILD_TYPE }}
        
        # åˆ›å»ºå‘å¸ƒç›®å½•
        mkdir "../../release"
        
        # å¤åˆ¶æ‰€æœ‰å¿…éœ€æ–‡ä»¶
        Copy-Item -Recurse -Force . "../../release/"
        
        # åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶
        $version = if ($env:GITHUB_REF -match "refs/tags/(.*)") { $matches[1] } else { "dev-$($env:GITHUB_SHA.Substring(0,7))" }
        echo "Version: $version" > "../../release/VERSION.txt"
        echo "Build Date: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" >> "../../release/VERSION.txt"
        echo "Commit: $env:GITHUB_SHA" >> "../../release/VERSION.txt"
        
        # åˆ›å»ºå¯åŠ¨è„šæœ¬
        @"
        @echo off
        echo ðŸš€ å¯åŠ¨ Qt Shadcn/UI è®¤è¯ç•Œé¢
        echo ç‰ˆæœ¬: $version
        echo.
        MyApp.exe
        "@ > "../../release/å¯åŠ¨ç¨‹åº.bat"
    
    - name: ðŸ—œï¸ Create Archive
      run: |
        $version = if ($env:GITHUB_REF -match "refs/tags/(.*)") { $matches[1] } else { "dev-$($env:GITHUB_SHA.Substring(0,7))" }
        $archiveName = "QtShadcnAuth-Windows-x64-$version.zip"
        
        Compress-Archive -Path "release/*" -DestinationPath $archiveName
        
        echo "ARCHIVE_NAME=$archiveName" >> $env:GITHUB_ENV
        echo "VERSION=$version" >> $env:GITHUB_ENV
    
    - name: ðŸ“¤ Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: QtShadcnAuth-Windows-x64-${{ env.VERSION }}
        path: ${{ env.ARCHIVE_NAME }}
        retention-days: 30
    
    - name: ðŸš€ Upload to Release
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        files: ${{ env.ARCHIVE_NAME }}

  # æž„å»ºä¿¡æ¯æ±‡æ€»
  build-summary:
    needs: build-windows
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ðŸ“‹ Build Summary
      run: |
        echo "## ðŸŽ¯ æž„å»ºç»“æžœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.build-windows.result }}" == "success" ]; then
          echo "âœ… **Windows æž„å»ºæˆåŠŸ**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ‰ Qt Shadcn/UI è®¤è¯ç•Œé¢å·²æˆåŠŸç¼–è¯‘ï¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ **ä¸‹è½½åœ°å€**: åœ¨ Actions é¡µé¢çš„ Artifacts ä¸­ä¸‹è½½" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Windows æž„å»ºå¤±è´¥**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "è¯·æ£€æŸ¥æž„å»ºæ—¥å¿—èŽ·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯ã€‚" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š æž„å»ºä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "- **Qt ç‰ˆæœ¬**: ${{ env.QT_VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "- **CMake ç‰ˆæœ¬**: ${{ env.CMAKE_VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "- **æž„å»ºç±»åž‹**: ${{ env.BUILD_TYPE }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ç›®æ ‡å¹³å°**: Windows x64" >> $GITHUB_STEP_SUMMARY
        echo "- **ç¼–è¯‘å™¨**: MSVC 2022" >> $GITHUB_STEP_SUMMARY
